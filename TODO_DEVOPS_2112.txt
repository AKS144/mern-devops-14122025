# 1. Clean old containers
try { docker rm -f jenkins-server } catch {}
try { docker network rm devops-net } catch {}

# 2. Create Network
docker network create devops-net
docker network connect devops-net minikube

# 3. Create Dockerfile for Jenkins
$dockerfile = @"
FROM jenkins/jenkins:lts
USER root
RUN apt-get update && apt-get install -y docker.io python3-pip wget unzip curl git
# Terraform
RUN wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip && unzip terraform_1.6.0_linux_amd64.zip && mv terraform /usr/local/bin/
# Kubectl
RUN curl -LO "https://dl.k8s.io/release/`$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && chmod +x kubectl && mv kubectl /usr/local/bin/
# Helm
RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
# Ansible
RUN pip3 install ansible kubernetes --break-system-packages
RUN ansible-galaxy collection install community.kubernetes
RUN usermod -aG docker jenkins
USER jenkins
"@
$dockerfile | Out-File Dockerfile -Encoding ASCII

# 4. Build & Run
docker build -t my-devops-jenkins .
docker run -d -p 9090:8080 -p 50000:50000 --name jenkins-server --network devops-net `
  -v //var/run/docker.sock:/var/run/docker.sock `
  --user root `
  my-devops-jenkins

Write-Host "Jenkins is running on http://localhost:9090" -ForegroundColor Green
Write-Host "Initial Password:"
docker exec jenkins-server cat /var/jenkins_home/secrets/initialAdminPassword

localhost:9090

kubectl logs -l app=backend -n mern-namespace  //check database connected



//direct deploy of ansible secret as not needed
kubectl create secret generic mern-secrets -n mern-namespace --from-literal=mongo-root-password=password123 --from-literal=mongo-keyfile=mysecretkeyformongo123 --from-literal=jwt-secret=supersecret




//
kubectl exec -it mongo-0 -n mern-namespace -- mongosh -u admin -p password123 --authenticationDatabase admin
try {
    var cfg = rs.conf();
    cfg.members[0].host = "mongo-0.mongo-service.mern-namespace.svc.cluster.local:27017";
    cfg.members[1].host = "mongo-1.mongo-service.mern-namespace.svc.cluster.local:27017";
    cfg.members[2].host = "mongo-2.mongo-service.mern-namespace.svc.cluster.local:27017";
    rs.reconfig(cfg, {force: true});
    print("Reconfiguration Successful");
} catch (e) {
    rs.initiate({
        _id: "rs0",
        members: [
            { _id: 0, host: "mongo-0.mongo-service.mern-namespace.svc.cluster.local:27017" },
            { _id: 1, host: "mongo-1.mongo-service.mern-namespace.svc.cluster.local:27017" },
            { _id: 2, host: "mongo-2.mongo-service.mern-namespace.svc.cluster.local:27017" }
        ]
    });
    print("Initialization Successful");
}
//



//grafana
password generate o nscreen
kubectl get secret --namespace monitoring monitoring-grafana -o jsonpath="{.data.admin-password}" | ForEach-Object { [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($_)) }
